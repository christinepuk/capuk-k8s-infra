name: Deploy to LKE

on:
  push:
    branches: [ main ]
    paths:
      - 'charts/**'
      - 'lke-values.yaml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  HELM_VERSION: "3.13.3"
  KUBECTL_VERSION: "1.30.0"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Validate Helm chart
        run: |
          helm lint charts/multi-service
          helm template test-release charts/multi-service \
            --values lke-values.yaml \
            --dry-run

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # Verify connection
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespace if not exists
        run: |
          kubectl create namespace multi-service --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update secrets
        run: |
          # Create rclone secret with environment variables
          cat > rclone.conf << EOF
          [linode]
          type = s3
          provider = Other
          env_auth = false
          access_key_id = ${{ secrets.ACCESS_KEY }}
          secret_access_key = ${{ secrets.SECRET_KEY }}
          region = us-iad-1
          endpoint = us-iad-1.linodeobjects.com
          EOF
          
          kubectl create secret generic rclone-secret \
            --from-file=rclone.conf=rclone.conf \
            --namespace=multi-service \
            --dry-run=client -o yaml | kubectl apply -f -
          
          rm -f rclone.conf

          # Create MySQL root password secret
          kubectl create secret generic mysql-root-secret \
            --from-literal=mysql-root-password="${{ secrets.MYSQL_ROOT_PASSWORD }}" \
            --namespace=multi-service \
            --dry-run=client -o yaml | kubectl apply -f -

          # Create WordPress database secrets
          for site in site1 site2 site3; do
            kubectl create secret generic mysql-${site}-secret \
              --from-literal=mysql-password="${{ secrets.MYSQL_PASSWORD }}" \
              --namespace=multi-service \
              --dry-run=client -o yaml | kubectl apply -f -
          done

      - name: Prepare values file with environment substitution
        env:
          PLEX_CLAIM_TOKEN: ${{ secrets.PLEX_CLAIM_TOKEN }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          CERT_MANAGER_EMAIL: ${{ secrets.CERT_MANAGER_EMAIL }}
        run: |
          # Substitute environment variables in lke-values.yaml
          envsubst < lke-values.yaml > deployment-values.yaml
          
          echo "Generated deployment-values.yaml with environment variables substituted"

      - name: Deploy with Helm
        run: |
          helm upgrade multi-service ./charts/multi-service \
            --values deployment-values.yaml \
            --namespace multi-service \
            --install \
            --wait \
            --timeout 10m \
            --atomic

      - name: Verify deployment
        run: |
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod \
            --selector=app.kubernetes.io/instance=multi-service \
            --namespace=multi-service \
            --timeout=300s

          # Check deployment status
          kubectl get pods -n multi-service
          kubectl get ingress -n multi-service
          kubectl get certificates -n multi-service

      - name: Test endpoints
        run: |
          # Test ingress endpoints
          echo "Testing endpoints..."
          
          # Get LoadBalancer IP
          LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "LoadBalancer IP: $LB_IP"
          
          # Test endpoints
          curl -I --connect-timeout 10 https://tv.christinepuk.net || echo "Plex endpoint not ready yet"
          curl -I --connect-timeout 10 https://blog.christinepuk.net || echo "Blog endpoint not ready yet"

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f deployment-values.yaml ~/.kube/config